---
 - name: Comparing last kernel and running kernel in RhelLinux OS
   shell: |
    LAST_KERNEL=$(rpm -q --last kernel | perl -pe 's/^kernel-(\S+).*/$1/' | head -1)
    CURRENT_KERNEL=$(uname -r)
    BOOT_CHECK=(initramfs-$LAST_KERNEL.img)
    BOOT_NEW=$(ls -al /boot |grep initramfs-$LAST_KERNEL.img |  awk '{print $9}')
    if [[ $BOOT_CHECK = $BOOT_NEW ]] &&  [[ $LAST_KERNEL != $CURRENT_KERNEL ]]; then
       # Set reboot flag
       touch /tmp/reboot
    else
       echo dont
    fi
   when: ansible_distribution == "RedHat" or ansible_distribution == "CentOS"
 - name: Comparing last kernel and running kernel in OracleLinux OS
   shell: |
    LAST_KERNEL=$(rpm -q --last kernel-uek| perl -pe 's/^kernel-uek-(\S+).*/$1/' | head -1)
    CURRENT_KERNEL=$(uname -r)
    BOOT_CHECK=(initramfs-$LAST_KERNEL.img)
    BOOT_NEW=$(ls -al /boot |grep initramfs-$LAST_KERNEL.img |  awk '{print $9}')
    if [[ $BOOT_CHECK = $BOOT_NEW ]] &&  [[ $LAST_KERNEL != $CURRENT_KERNEL ]]; then
       # Set reboot flag
       touch /tmp/reboot
    else
       echo dont
    fi
   when: ansible_distribution == "OracleLinux"
 - name: Checking if reboot flag exists
   stat:
    path: /tmp/reboot
   register: reboot

 - name: Clearing reboot flag
   file:
    path: /tmp/reboot
    state: absent
   when: reboot.stat.exists == true

 - name: Reboot and add eagerfpu in kernel parameter
   shell:
    cmd: /sbin/grubby --update-kernel=ALL --args=eagerfpu=off

 - name: Rebooting host(s).
   shell: sleep 2 && /sbin/shutdown -r now "Reboot required for updated kernel." && sleep 2
   async: 60
   poll: 0
   when: reboot.stat.exists == true

 - name: Waiting for host(s) to reboot
   wait_for_connection:
    delay: 180
    timeout: 300
   when: reboot.stat.exists == true
...
